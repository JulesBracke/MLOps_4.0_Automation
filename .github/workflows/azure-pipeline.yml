name: Azure ML - Animals Pipeline

on:
  workflow_dispatch:

permissions:
  contents: read
  packages: write

env:
  GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
  WORKSPACE: ${{ secrets.AZURE_ML_WORKSPACE }}
  LOCATION: ${{ secrets.AZURE_LOCATION }}

jobs:
  azure-pipeline:
    runs-on: ubuntu-24.04

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Optional: log CLI version for your report (QUESTION 1)
      - name: Azure CLI version
        run: |
          echo "Azure CLI version on runner:"
          az --version

      # One-time setup: ML extension + defaults
      - name: Azure -- Setup ML extension & defaults
        run: |
          az extension add -n ml -y || az extension update -n ml
          az configure --defaults group=$GROUP workspace=$WORKSPACE location=$LOCATION

      # 1. Compute — Creation
      - name: Azure -- Create compute
        run: |
          if az ml compute show --name cli-created-machine >/dev/null 2>&1; then
            echo "Compute 'cli-created-machine' already exists, skipping creation."
          else
            echo "Creating compute 'cli-created-machine' from YAML..."
            az ml compute create --file ./environment/compute.yaml
          fi

      # 2. Compute — Start
      - name: Azure -- Start Compute
        run: |
          az ml compute start --name cli-created-machine || echo "Compute already running or cannot be started."
        continue-on-error: true

      # 3a. Environments
      - name: Azure -- Environment Setup
        run: |
          az ml environment create --file ./environment/pillow.yaml
          az ml environment create --file ./environment/tensorflow.yaml

      # 3b. Components
      - name: Azure -- Component Setup
        run: |
          az ml component create --file ./components/dataprep/dataprep.yaml
          az ml component create --file ./components/dataprep/data_split.yaml
          az ml component create --file ./components/training/training.yaml

      # 4. Pipeline run
      - name: Azure -- Pipeline Run
        run: |
          az ml job create \
            --file ./pipelines/animals-classification.yaml \
            --stream \
            --set name=animals-classification-${{ github.sha }}-${{ github.run_id }}

      # Cleanup compute
      - name: Azure -- Stop Compute
        run: |
          az ml compute stop --name cli-created-machine || echo "Compute already stopped."
        continue-on-error: true

  download:
    needs: azure-pipeline
    runs-on: ubuntu-24.04

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Azure -- Setup ML extension & defaults
        run: |
          az extension add -n ml -y || az extension update -n ml
          az configure --defaults group=$GROUP workspace=$WORKSPACE location=$LOCATION

      - name: Azure -- Download Model
        run: |
          JOB_NAME="animals-classification-${{ github.sha }}-${{ github.run_id }}"
          echo "Downloading model output from job: $JOB_NAME"

          mkdir -p inference/model

          az ml job download \
            --name "$JOB_NAME" \
            --output-name model \
            --download-path inference/model

      - name: Docker -- Upload API code from Inference
        uses: actions/upload-artifact@v4.3.3
        with:
          name: docker-config
          path: inference

  deploy-image:
    needs: download
    runs-on: ubuntu-24.04

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      # Gather Docker meta (tags & labels)
      - name: Docker -- Gather Tags
        id: docker-meta-data
        uses: docker/metadata-action@v5.5.1
        with:
          images: |
            ghcr.io/${{ github.repository_owner }}/mlops-animals-api
          tags: |
            type=ref,event=branch
            type=sha

      # Login to GitHub Container Registry
      - name: Docker -- Login to GHCR
        uses: docker/login-action@v3.2.0
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Download inference code + model from previous job
      - name: Docker -- Download API Code for Inference
        uses: actions/download-artifact@v4.1.7
        with:
          name: docker-config
          path: inference

      # Build and push image
      - name: Docker Build and push
        id: docker_build
        uses: docker/build-push-action@v5.3.0
        with:
          context: ./inference
          push: true
          tags: ${{ steps.docker-meta-data.outputs.tags }}
          labels: ${{ steps.docker-meta-data.outputs.labels }}