name: Azure ML - Animals Pipeline

on:
  workflow_dispatch:

env:
  GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
  WORKSPACE: ${{ secrets.AZURE_ML_WORKSPACE }}
  LOCATION: ${{ secrets.AZURE_LOCATION }}

jobs:
  azure-pipeline:
    runs-on: ubuntu-24.04

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # 1. Compute — Creation
      - name: Azure -- Create compute
        uses: Azure/CLI@v2.1.0
        with:
          azcliversion: 2.66.0
          inlineScript: |
            az configure --defaults group=$GROUP workspace=$WORKSPACE location=$LOCATION
            az ml compute create --file ./environment/compute.yaml

      # 2. Compute — Start (with continue-on-error as in assignment)
      - name: Azure -- Start Compute
        uses: Azure/CLI@v2.1.0
        with:
          azcliversion: 2.66.0
          inlineScript: |
            az configure --defaults group=$GROUP workspace=$WORKSPACE location=$LOCATION
            az ml compute start --name cli-created-machine
        continue-on-error: true

      # 3a. Environments
      - name: Azure -- Environment Setup
        uses: Azure/CLI@v2.1.0
        with:
          azcliversion: 2.66.0
          inlineScript: |
            az configure --defaults group=$GROUP workspace=$WORKSPACE location=$LOCATION
            az ml environment create --file ./environment/pillow.yaml
            az ml environment create --file ./environment/tensorflow.yaml

      # 3b. Components
      - name: Azure -- Component Setup
        uses: Azure/CLI@v2.1.0
        with:
          azcliversion: 2.66.0
          inlineScript: |
            az configure --defaults group=$GROUP workspace=$WORKSPACE location=$LOCATION
            az ml component create --file ./components/dataprep/dataprep.yaml
            az ml component create --file ./components/dataprep/data_split.yaml
            az ml component create --file ./components/training/training.yaml

      # 4. Pipeline run
      - name: Azure -- Pipeline Run
        uses: Azure/CLI@v2.1.0
        with:
          azcliversion: 2.66.0
          inlineScript: |
            az configure --defaults group=$GROUP workspace=$WORKSPACE location=$LOCATION
            az ml job create \
              --file ./pipelines/animals-classification.yaml \
              --stream \
              --set name=animals-classification-${{ github.sha }}-${{ github.run_id }}

      # Cleanup compute
      - name: Azure -- Stop Compute
        uses: Azure/CLI@v2.1.0
        with:
          azcliversion: 2.66.0
          inlineScript: |
            az configure --defaults group=$GROUP workspace=$WORKSPACE location=$LOCATION
            az ml compute stop --name cli-created-machine
        continue-on-error: true
